<% settings_form ||= nil %>
<div class="space-y-4 mt-4 pt-4">
  <h3 class="text-lg font-semibold">Настройки триггера показа формы</h3>
  
  <div>
    <% if settings_form %>
      <%= settings_form.label :trigger_type, "Тип триггера", class: "block text-sm font-medium text-gray-700" %>
      <%= settings_form.select :trigger_type,
          options_for_select([
            ['Ручной показ', 'manual'],
            ['Попытка покинуть сайт', 'exit_intent'],
            ['Время на странице', 'time_on_page'],
            ['Глубина прокрутки', 'scroll_depth']
          ], webform.settings&.dig('trigger_type') || Webform.default_trigger_type_for_kind(webform.kind)),
          {},
          { 
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5",
            data: { turbo_frame: "trigger_value_field" },
            onchange: "Turbo.visit('#{trigger_value_field_account_webform_path(current_account, webform)}?trigger_type=' + this.value, { frame: 'trigger_value_field' })"
          } %>
    <% else %>
      <%= label_tag "webform_settings_trigger_type", "Тип триггера", class: "block text-sm font-medium text-gray-700" %>
      <%= form_with url: trigger_value_field_account_webform_path(current_account, webform), 
          method: :get, 
          data: { turbo_frame: "trigger_value_field" },
          class: "inline-block w-full" do |f| %>
        <%= select_tag "trigger_type",
            options_for_select([
              ['Ручной показ', 'manual'],
              ['Попытка покинуть сайт', 'exit_intent'],
              ['Время на странице', 'time_on_page'],
              ['Глубина прокрутки', 'scroll_depth']
            ], webform.settings&.dig('trigger_type') || Webform.default_trigger_type_for_kind(webform.kind)),
            name: "trigger_type",
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5",
            onchange: "this.form.requestSubmit()" %>
      <% end %>
    <% end %>
  </div>
  
  <!-- Turbo Frame для динамического обновления поля trigger_value и информационных блоков -->
  <%= turbo_frame_tag "trigger_value_field" do %>
    <% current_trigger_type = webform.settings&.dig('trigger_type') || Webform.default_trigger_type_for_kind(webform.kind) %>
    
    <% if current_trigger_type == 'manual' %>
      <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md">
        <p class="text-sm text-blue-800">
          <strong>Как это работает:</strong> Форма будет показываться только при клике на элементы с атрибутом <code class="bg-blue-100 px-1 rounded">data-twc-webform-id="<%= webform.id %>"</code>.
        </p>
        <p class="text-sm text-blue-700 mt-2">
          <strong>Пример использования:</strong>
        </p>
        <pre class="text-xs bg-blue-100 p-2 rounded mt-1 overflow-x-auto"><code>&lt;button data-twc-webform-id="<%= webform.id %>"&gt;Показать форму&lt;/button&gt;

&lt;!-- С дополнительными параметрами --&gt;
&lt;a href="#" data-twc-webform-id="<%= webform.id %>" 
   data-product-id="123" 
   data-variant-id="456"&gt;
  Заказать товар
&lt;/a&gt;</code></pre>
      </div>
    <% elsif ['time_on_page', 'scroll_depth'].include?(current_trigger_type) %>
      <div>
        <% if settings_form %>
          <%= settings_form.label :trigger_value, "Значение", class: "block text-sm font-medium text-gray-700" %>
          <%= settings_form.number_field :trigger_value,
              value: webform.settings&.dig('trigger_value'),
              placeholder: current_trigger_type == 'time_on_page' ? '30 (секунды)' : '75 (проценты)',
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
        <% else %>
          <%= label_tag "webform_settings_trigger_value", "Значение", class: "block text-sm font-medium text-gray-700" %>
          <%= number_field_tag "webform[settings][trigger_value]",
              webform.settings&.dig('trigger_value'),
              placeholder: current_trigger_type == 'time_on_page' ? '30 (секунды)' : '75 (проценты)',
              class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
        <% end %>
        <p class="mt-1 text-sm text-gray-500">
          <% if current_trigger_type == 'time_on_page' %>
            Форма покажется через указанное количество секунд после загрузки страницы. По умолчанию работает на всех страницах, где подключен скрипт webform.js. Можно настроить таргетинг страниц через дополнительные настройки (в разработке).
          <% elsif current_trigger_type == 'scroll_depth' %>
            Форма покажется при прокрутке страницы на указанный процент. По умолчанию работает на всех страницах, где подключен скрипт webform.js. Можно настроить таргетинг страниц через дополнительные настройки (в разработке).
          <% end %>
        </p>
      </div>
    <% elsif current_trigger_type == 'exit_intent' %>
      <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-md">
        <p class="text-sm text-green-800">
          <strong>Как это работает:</strong> Форма автоматически покажется, когда пользователь попытается покинуть сайт (движение мыши к верхней части окна).
        </p>
      </div>
    <% end %>
  <% end %>
  
  <div>
    <% if settings_form %>
      <%= settings_form.label :show_delay, "Задержка перед показом (мс)", class: "block text-sm font-medium text-gray-700" %>
      <%= settings_form.number_field :show_delay,
          value: webform.settings&.dig('show_delay') || 0,
          min: 0,
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
    <% else %>
      <%= label_tag "webform_settings_show_delay", "Задержка перед показом (мс)", class: "block text-sm font-medium text-gray-700" %>
      <%= number_field_tag "webform[settings][show_delay]",
          webform.settings&.dig('show_delay') || 0,
          min: 0,
          class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
    <% end %>
  </div>
  
  <div>
    <% if settings_form %>
      <%= settings_form.check_box :show_once_per_session,
          { checked: webform.settings&.dig('show_once_per_session') != false, class: "rounded border-gray-300" } %>
      <%= settings_form.label :show_once_per_session, "Показывать только раз за сессию", class: "ml-2 text-sm text-gray-700" %>
    <% else %>
      <%= check_box_tag "webform[settings][show_once_per_session]",
          '1',
          webform.settings&.dig('show_once_per_session') != false,
          class: "rounded border-gray-300" %>
      <%= label_tag "webform_settings_show_once_per_session", "Показывать только раз за сессию", class: "ml-2 text-sm text-gray-700" %>
    <% end %>
  </div>
  
  <!-- Дополнительные настройки: target_pages, exclude_pages -->
  <div class="mt-4 pt-4 border-t border-gray-200">
    <h4 class="text-md font-medium text-gray-700 mb-3">Таргетинг страниц</h4>
    
    <div class="mb-4">
      <% if settings_form %>
        <%= settings_form.label :target_pages, "Показывать только на страницах (URL или путь)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <p class="text-xs text-gray-500 mb-2">Оставьте пустым, чтобы показывать на всех страницах. Укажите один URL или путь на строку.</p>
        <%= settings_form.text_area :target_pages,
            value: (webform.settings&.dig('target_pages') || []).join("\n"),
            placeholder: "/products\n/cart\n/about",
            rows: 3,
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5 font-mono text-sm" %>
      <% else %>
        <%= label_tag "webform_settings_target_pages", "Показывать только на страницах (URL или путь)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <p class="text-xs text-gray-500 mb-2">Оставьте пустым, чтобы показывать на всех страницах. Укажите один URL или путь на строку.</p>
        <%= text_area_tag "webform[settings][target_pages]",
            (webform.settings&.dig('target_pages') || []).join("\n"),
            placeholder: "/products\n/cart\n/about",
            rows: 3,
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5 font-mono text-sm" %>
      <% end %>
    </div>
    
    <div>
      <% if settings_form %>
        <%= settings_form.label :exclude_pages, "Исключить страницы (URL или путь)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <p class="text-xs text-gray-500 mb-2">Укажите URL или путь, на которых форма НЕ будет показываться. Один URL или путь на строку.</p>
        <%= settings_form.text_area :exclude_pages,
            value: (webform.settings&.dig('exclude_pages') || []).join("\n"),
            placeholder: "/checkout\n/admin",
            rows: 3,
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5 font-mono text-sm" %>
      <% else %>
        <%= label_tag "webform_settings_exclude_pages", "Исключить страницы (URL или путь)", class: "block text-sm font-medium text-gray-700 mb-2" %>
        <p class="text-xs text-gray-500 mb-2">Укажите URL или путь, на которых форма НЕ будет показываться. Один URL или путь на строку.</p>
        <%= text_area_tag "webform[settings][exclude_pages]",
            (webform.settings&.dig('exclude_pages') || []).join("\n"),
            placeholder: "/checkout\n/admin",
            rows: 3,
            class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5 font-mono text-sm" %>
      <% end %>
    </div>
  </div>
</div>

