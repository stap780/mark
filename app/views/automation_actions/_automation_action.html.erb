<%= turbo_frame_tag "automation_action_#{turbo_id_for(automation_action)}" do %>
  <%= fields_for "automation_rule[automation_actions_attributes][#{turbo_id_for(automation_action)}]", automation_action do |ff| %>
    <div class="grid grid-cols-[2fr_2fr_50px] gap-4 p-3 border rounded mb-2 bg-gray-50" 
         id="automation_action_<%= automation_action.persisted? ? automation_action.id : turbo_id_for(automation_action) %>">
      
      <!-- Kind select -->
      <div>
        <% current_kind = automation_action.kind.presence || 'send_email' %>
        <%= ff.select :kind,
            [["Отправить email", "send_email"], ["Изменить статус", "change_status"]],
            { selected: current_kind, include_blank: false },
            { 
              class: "w-full px-2 py-1 border rounded-md text-sm"
            } %>
      </div>

      <!-- Conditional fields based on kind -->
      <div>
        <% if current_kind == 'send_email' %>
          <%= ff.select :value,
              options_for_select(
                current_account.message_templates.email.pluck(:title, :id),
                automation_action.value
              ),
              { include_blank: "Выберите шаблон" },
              { 
                class: "w-full px-2 py-1 border rounded-md text-sm"
              } %>
        <% elsif current_kind == 'change_status' %>
          <%= ff.select :value,
              options_for_select(
                Incase.statuses.map { |key, value| [t("incases.status.#{key}"), value] },
                automation_action.value
              ),
              { include_blank: "Выберите статус" },
              { 
                class: "w-full px-2 py-1 border rounded-md text-sm"
              } %>
        <% end %>
        
        <%= ff.hidden_field :position, value: automation_action.position || automation_rule.automation_actions.count %>
      </div>

      <!-- Delete button -->
      <div class="flex items-center">
        <% path = automation_action.new_record? ? account_automation_action_path(current_account, id: turbo_id_for(automation_action)) : account_automation_rule_automation_action_path(current_account, automation_rule, automation_action) %>
        <%= link_to_delete path, data: { turbo_method: :delete, turbo_confirm: 'Удалить действие?' } %>
        <%= ff.hidden_field :id if automation_action.persisted? %>
      </div>
    </div>
  <% end %>
<% end %>

