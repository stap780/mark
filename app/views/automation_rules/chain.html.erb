<div class="bg-white rounded-lg shadow p-4">
  <div class="inline-flex items-center gap-4 mb-4">
    <%= link_to t('back'), account_automation_rules_path(current_account),data: { turbo: false },
      class: "inline-flex items-center px-3 py-1 bg-white text-violet-600 border border-violet-500 rounded-md hover:bg-violet-50" %>
  </div>


    <div class="space-y-4">
      <%# Блок Триггер — начальное событие, его нельзя удалить %>
      <div class="rounded-lg border bg-white p-4">
        <%= form_with model: [current_account, @automation_rule],
            data: { turbo_stream: true, controller: "auto-submit", "auto-submit-delay-value": 500 }, class: "space-y-0" do |f| %>
          <%= render "shared/errors", object: @automation_rule %>
          <h2 class="text-sm font-medium text-gray-700 mb-3"><%= t('.block_trigger') %><span class="text-xs text-gray-400 ml-2"><%= t('.initial_event_undeletable') %></span></h2>
          <div class="flex flex-wrap gap-4">
            <div class="flex-1 min-w-[200px]">
              <%= f.label :title, t('.field_title'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :title, class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
            </div>
            <div class="flex-1 min-w-[200px]">
              <%= f.label :event, t('.field_event'), class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.select :event,
                  AutomationRule::EVENTS.map { |key, value| [value, key] },
                  { selected: @automation_rule.event, include_blank: t('.select_event') },
                  class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
            </div>
            <div class="flex items-center">
              <%= f.label :active, class: "flex items-center" do %>
                <%= f.check_box :active, class: "mr-2" %>
                <span><%= t('.active_label') %></span>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      <%# Кнопка «+» после триггера — вставить первый шаг %>
      <div class="flex justify-center">
        <%= link_to add_block_account_automation_rule_path(current_account, @automation_rule, insert_after_step_id: nil),
            data: { turbo_frame: :offcanvas, turbo_prefetch: false },
            class: "inline-flex items-center justify-center w-10 h-10 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition-colors",
            title: t("automation_rules.chain.add_block_modal_title") do %>
          <span class="text-xl leading-none" aria-hidden="true">+</span>
        <% end %>
      </div>

      <%# Дерево шагов с ветвлением Да/Нет после условий %>
      <%= turbo_frame_tag dom_id(current_account, dom_id(@automation_rule, :steps)), class: "space-y-4" do %>
        <%= render "automation_rules/steps_tree", automation_rule: @automation_rule, current_account: current_account %>
      <% end %>
    </div>
  
</div>
