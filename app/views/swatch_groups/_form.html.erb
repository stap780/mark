<%= form_with model: [current_account, @swatch_group], class: "space-y-6" do |f| %>
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left column: basic info + products -->
    <div class="space-y-6">
      <div class="bg-white rounded-lg border p-4 space-y-4">
        <div>
          <%= f.label :name, class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
        </div>
        <div>
          <%= f.label :option_name, class: "block text-sm font-medium text-gray-700" %>
          <%= f.text_field :option_name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
        </div>
      </div>

      <div class="bg-white rounded-lg border p-4" data-controller="items-bucket">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-sm font-medium text-gray-700">Items</h3>

          <% picker_path = items_picker_account_insales_path(current_account) %>
          <%= link_to "Add items", picker_path,
                data: { turbo_frame: :offcanvas },
                class: "inline-flex items-center px-3 py-1 border rounded-md text-gray-700 hover:bg-gray-50" %>
        </div>

        <div class="space-y-2" data-items-bucket-target="list"></div>
        <% if @swatch_group.persisted? %>
          <% assigned = @swatch_group.swatch_group_products.includes(:product).ordered %>
          <% if assigned.any? %>
            <div class="mt-3 space-y-2">
              <% assigned.each do |sgp| %>
                <div id="<%= dom_id(sgp) %>" class="flex items-center justify-between p-2 border rounded">
                  <div class="flex items-center space-x-2">
                    <% v = sgp.product.variants.joins(:varbinds).where(varbinds: { value: sgp.swatch_value }).first %>
                    <img src="<%= v&.image_link.presence || sgp.product.image_link %>" class="h-8 w-8 object-cover rounded" onerror="this.style.display='none'">
                    <div class="text-sm">
                      <div class="font-medium"><%= sgp.product.title %></div>
                      <div class="text-gray-600 text-xs">Value: <%= sgp.swatch_value %>
                        <% if v %>
                          â€¢ Price: <%= v.price %>
                        <% end %>
                      </div>
                    </div>
                  </div>
                  <%= link_to "Remove", account_swatch_group_swatch_group_product_path(current_account, @swatch_group, sgp),
                        data: { turbo_method: :delete, turbo_confirm: "Remove item?", turbo_stream: true },
                        class: "text-red-600 text-xs hover:underline" %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- Right column: status + styles + image source -->
    <div class="space-y-6">
      <div class="bg-white rounded-lg border p-4">
        <%= f.label :status, class: "block text-sm font-medium text-gray-700" %>
        <%= f.select :status, SwatchGroup.statuses.keys, {}, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
      </div>

      <div class="bg-white rounded-lg border p-4 space-y-4">
        <div>
          <div class="flex items-center justify-between">
            <%= f.label :product_page_style, "Product page style", class: "block text-sm font-medium text-gray-700" %>
            <%= link_to "Select style", style_selector_account_swatch_groups_path(current_account, field: :product_page_style, current: @swatch_group.product_page_style),
                  data: { turbo_frame: :offcanvas }, class: "text-violet-600 hover:underline text-sm" %>
          </div>
          <div class="mt-1 rounded-md border p-3">
            <div id="summary_product_page_style" class="text-sm text-gray-700"><%= SwatchGroup.style_label_for(@swatch_group.product_page_style) || "Not selected" %></div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700">Swatch image source</label>
            <%= f.select :swatch_image_source,
                options_for_select([
                  ["First product image", "first_product_image"],
                  ["Second product image", "second_product_image"],
                  ["Last product image", "last_product_image"],
                  ["Color / custom image", "custom_image"]
                ], @swatch_group.swatch_image_source),
                {},
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
          </div>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <%= f.label :collection_page_style, "Collection page style", class: "block text-sm font-medium text-gray-700" %>
            <%= link_to "Select style", style_selector_account_swatch_groups_path(current_account, field: :collection_page_style, current: @swatch_group.collection_page_style),
                  data: { turbo_frame: :offcanvas }, class: "text-violet-600 hover:underline text-sm" %>
          </div>
          <div class="mt-1 rounded-md border p-3">
            <div id="summary_collection_page_style" class="text-sm text-gray-700"><%= SwatchGroup.style_label_for(@swatch_group.collection_page_style) || "Not selected" %></div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700">Swatch image source</label>
            <%= f.select :swatch_image_source,
                options_for_select([
                  ["First product image", "first_product_image"],
                  ["Second product image", "second_product_image"],
                  ["Last product image", "last_product_image"],
                  ["Color / custom image", "custom_image"]
                ], @swatch_group.swatch_image_source),
                {},
                class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 px-3 py-2.5" %>
            <p class="mt-1 text-xs text-gray-500">Applies to both pages for now.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div>
    <%= f.submit t(:save), class: "inline-flex items-center px-3 py-1 bg-violet-600 text-white rounded-md hover:bg-violet-700" %>
    <%= link_to t(:back), account_swatch_groups_path(current_account), class: "inline-flex items-center px-3 py-1 bg-white text-violet-700 border border-violet-600 rounded-md hover:bg-violet-50", data: {turbo: false} %>
  </div>
<% end %>
