<%
  last_message = conversation.messages.order(created_at: :desc).first
  preview = last_message&.content&.truncate(60) || "Нет сообщений"
  is_active = params[:id].to_s == conversation.id.to_s
  unread = conversation.has_unread_incoming?
  # Пункт списка: id = account + conversation (для turbo_stream при close/reopen).
  item_id = dom_id(current_account, dom_id(conversation))
  right_slot_id = dom_id(current_account, :conversation)
  row_class = "border-b"
  row_class += " conversation-row-new-message" if unread
%>
<div id="<%= item_id %>" class="<%= row_class %>" data-controller="conversation-row" <%= "data-conversation-row-highlight-value=true" if unread %>>
  <%= link_to account_conversation_path(current_account, conversation),
      data: { turbo_frame: right_slot_id, turbo_prefetch: false },
      class: "block p-4 hover:bg-gray-50 #{'bg-violet-50 border-violet-200' if is_active}" do %>
    <div class="flex items-start gap-3">
    <!-- Аватар/Инициалы -->
    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-violet-100 flex items-center justify-center text-violet-700 font-medium text-sm">
      <%= conversation.client&.name.first.upcase %>
    </div>
    
    <div class="flex-1 min-w-0">
      <!-- Имя клиента и индикатор «Новое» -->
      <div class="flex items-center justify-between mb-1 gap-2">
        <h3 class="font-medium text-gray-900 truncate min-w-0">
          <%= conversation.client.name %>
          <% if conversation.client.surname.present? %>
            <%= conversation.client.surname %>
          <% end %>
        </h3>
        <% if unread %>
          <span class="flex-shrink-0 px-1.5 py-0.5 text-[10px] font-medium bg-violet-500 text-white rounded" data-conversation-row-target="badge">Новое</span>
        <% elsif conversation.waiting_for_response? %>
          <span class="flex-shrink-0 w-2 h-2 bg-orange-500 rounded-full" title="Ожидает ответа"></span>
        <% end %>
      </div>
      
      <!-- Превью последнего сообщения -->
      <p class="text-sm text-gray-600 truncate mb-1">
        <%= preview %>
      </p>
      
      <!-- Дата и статус -->
      <div class="flex items-center justify-between text-xs text-gray-500">
        <span>
          <% if last_message %>
            <%= l(last_message.created_at, format: :short) %>
          <% elsif conversation.last_message_at %>
            <%= l(conversation.last_message_at, format: :short) %>
          <% else %>
            <%= l(conversation.created_at, format: :short) %>
          <% end %>
        </span>
        <span class="px-2 py-0.5 rounded text-xs <%= 
          case conversation.status
          when 'active'
            'bg-green-100 text-green-700'
          when 'closed'
            'bg-gray-100 text-gray-700'
          when 'archived'
            'bg-gray-100 text-gray-500'
          else
            'bg-gray-100 text-gray-700'
          end
        %>">
          <%= t("conversations.status.#{conversation.status}") %>
        </span>
      </div>
    </div>
  </div>
  <% end %>
</div>
