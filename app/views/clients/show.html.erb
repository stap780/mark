<%= render 'shared/offcanvas_inner', title: t('.heading', name: @client.name) do %>
  <div class="space-y-6">
    <%# Списки товаров %>
    <div>
      <h3 class="text-lg font-semibold mb-3">Товары в списках</h3>
      <%# Load list items grouped by list %>
      <% list_items = (defined?(@client.list_items) ? @client.list_items : ListItem.where(client: @client)).includes(:list, :item) %>
      <% grouped = list_items.group_by(&:list) %>

      <% if grouped.blank? %>
        <div><%= t('.no_list_items') %></div>
      <% else %>
        <% grouped.each do |list, items| %>
          <div>
            <h3 style="margin:0 0 8px 0; font-weight:600;"><%= t('.list') %>: <%= list&.name || t('.unnamed_list') %> (<%= items.size %>)</h3>
            <table style="width:100%; border-collapse:collapse; border:1px solid #e5e7eb;">
              <thead>
                <tr style="background:#f9fafb;">
                  <th style="padding:12px; text-align:left; border-bottom:1px solid #e5e7eb; font-weight:600;"><%= t('.image') %></th>
                  <th style="padding:12px; text-align:left; border-bottom:1px solid #e5e7eb; font-weight:600;"><%= t('.product_title') %></th>
                  <th style="padding:12px; text-align:right; border-bottom:1px solid #e5e7eb; font-weight:600;"><%= t('.price') %></th>
                </tr>
              </thead>
              <tbody>
                <% items.each do |li| %>
                  <% raw_item = li.item %>
                  <% product = if raw_item.is_a?(Product)
                    raw_item
                  elsif raw_item.respond_to?(:product)
                    raw_item.product
                  else
                    nil
                  end %>

                  <% title = product&.title || (raw_item.respond_to?(:title) ? raw_item.title : "Item ##{li.item_id}") %>
                  <% first_variant = product&.variants&.first || (raw_item.respond_to?(:image_link) ? raw_item : nil) %>
                  <% image_link = first_variant&.respond_to?(:image_link) ? first_variant.image_link : nil %>
                  <% price = first_variant&.respond_to?(:price) ? first_variant.price : nil %>

                  <tr style="border-bottom:1px solid #f3f4f6;">
                    <td style="padding:12px; border-bottom:1px solid #f3f4f6;">
                      <div style="width:60px; height:60px; border-radius:6px; overflow:hidden; background:#f3f4f6; display:flex; align-items:center; justify-content:center;">
                        <% if image_link.present? %>
                          <img src="<%= image_link %>" alt="<%= title %>" style="width:100%; height:100%; object-fit:cover; display:block;" />
                        <% else %>
                          <span style="font-size:10px; color:#9ca3af;"><%= t('.no_image') %></span>
                        <% end %>
                      </div>
                    </td>
                    <td style="padding:12px; border-bottom:1px solid #f3f4f6; font-weight:500;">
                      <%= title %>
                    </td>
                    <td style="padding:12px; border-bottom:1px solid #f3f4f6; text-align:right;">
                      <% if price.present? %>
                        <%= number_to_currency(price, unit: "₽", separator: ",", delimiter: " ", format: "%n %u") %>
                      <% else %>
                        <span style="color:#9ca3af;">—</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>