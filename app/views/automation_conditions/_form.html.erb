<%= form_with model: [current_account, @automation_rule, @step, @automation_condition],
    data: (@automation_condition.persisted? ? { turbo_stream: true, controller: "auto-submit", "auto-submit-delay-value": 200 } : { turbo_stream: true }),
    class: "space-y-2" do |f| %>
  <%= render "shared/errors", object: @automation_condition %>
  <div class="grid grid-cols-[2fr_2fr_2fr_100px] gap-2 p-3 border rounded mb-2 bg-gray-50 items-center">
    <%= f.hidden_field :position, value: @step.automation_conditions.count %>
    <div>
      <%= f.label :field, t('automation_conditions.select_field'), class: "block text-sm font-medium text-gray-700" if @automation_condition.new_record? %>
      <%= f.select :field,
          options_for_select(
            (@automation_rule.event ? available_fields_for_event(@automation_rule.event).map { |fn| [fn[:label], fn[:key]] } : []),
            @automation_condition.field
          ),
          { include_blank: false },
          { class: "mt-1 block w-full rounded-md border-gray-300 px-3 py-2" } %>
    </div>
    <div>
      <%= f.label :operator, t('automation_conditions.select_operator'), class: "block text-sm font-medium text-gray-700" if @automation_condition.new_record? %>
      <% field_info = (@automation_rule.event ? available_fields_for_event(@automation_rule.event).find { |fn| fn[:key] == @automation_condition.field } : nil) %>
      <% available_ops = field_info ? available_operators_for_field(field_info) : available_operators %>
      <%= f.select :operator,
          options_for_select(available_ops.map { |op| [op[:label], op[:key]] }, @automation_condition.operator),
          { include_blank: false },
          { class: "mt-1 block w-full rounded-md border-gray-300 px-3 py-2" } %>
    </div>
    <div>
      <%= f.label :value, t('automation_conditions.select_value'), class: "block text-sm font-medium text-gray-700" if @automation_condition.new_record? %>
      <% field_info = (@automation_rule.event ? available_fields_for_event(@automation_rule.event).find { |fn| fn[:key] == @automation_condition.field } : nil) %>
      <% input_type = input_type_for_condition(field_info, @automation_condition.operator) %>
      <% if input_type == 'select' && field_info %>
        <% select_options = select_options_for_condition(field_info, @automation_condition.operator) %>
        <%= f.select :value, options_for_select(select_options, @automation_condition.value),
            { include_blank: false },
            { class: "mt-1 block w-full rounded-md border-gray-300 px-3 py-2", data: { "auto-submit-ignore": true } } %>
      <% elsif input_type == 'number' %>
        <%= f.number_field :value, value: @automation_condition.value, placeholder: t('automation_conditions.value_placeholder'),
            class: "mt-1 block w-full rounded-md border-gray-300 px-3 py-2", data: { "auto-submit-ignore": true } %>
      <% else %>
        <%= f.text_field :value, value: @automation_condition.value, placeholder: t('automation_conditions.value_placeholder'),
            class: "mt-1 block w-full rounded-md border-gray-300 px-3 py-2", data: { "auto-submit-ignore": true } %>
      <% end %>
    </div>
    <div>
      <%= f.submit t('save'), class: "inline-flex items-center px-3 py-1 bg-violet-600 text-white rounded-md hover:bg-violet-700" %>
    </div>
  </div>
<% end %>
