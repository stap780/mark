<%= turbo_frame_tag "automation_condition_#{turbo_id_for(automation_condition)}" do %>
  <%= fields_for "automation_rule[automation_conditions_attributes][#{turbo_id_for(automation_condition)}]", automation_condition do |ff| %>
    <div class="grid grid-cols-[2fr_2fr_2fr_50px] gap-4 p-3 border rounded mb-2 bg-gray-50" 
         id="automation_condition_<%= automation_condition.persisted? ? automation_condition.id : turbo_id_for(automation_condition) %>">
      
      <!-- Field select -->
      <div>
        <%= ff.select :field,
            options_for_select(
              (automation_rule.event ? available_fields_for_event(automation_rule.event).map { |f| [f[:label], f[:key]] } : []),
              automation_condition.field
            ),
            { include_blank: "Выберите поле" },
            { 
              class: "w-full px-2 py-1 border rounded-md text-sm"
            } %>
      </div>

      <!-- Operator select -->
      <div>
        <% field_info = (automation_rule.event ? available_fields_for_event(automation_rule.event).find { |f| f[:key] == automation_condition.field } : nil) %>
        <% available_ops = field_info ? available_operators_for_field(field_info) : available_operators %>
        <%= ff.select :operator,
            options_for_select(
              available_ops.map { |op| [op[:label], op[:key]] },
              automation_condition.operator
            ),
            { include_blank: "Выберите значение" },
            { 
              class: "w-full px-2 py-1 border rounded-md text-sm"
            } %>
      </div>

      <!-- Value input -->
      <div>
        <% 
          field_info = (automation_rule.event ? available_fields_for_event(automation_rule.event).find { |f| f[:key] == automation_condition.field } : nil)
          operator = automation_condition.operator
          input_type = input_type_for_condition(field_info, operator)
        %>
        
        <% if input_type == 'select' && field_info %>
          <% select_options = select_options_for_condition(field_info, operator) %>
          <%= ff.select :value,
              options_for_select(select_options, automation_condition.value),
              { include_blank: "Выберите значение" },
              { 
                class: "w-full px-2 py-1 border rounded-md text-sm"
              } %>
        <% elsif input_type == 'number' %>
          <%= ff.number_field :value,
              value: automation_condition.value,
              placeholder: "Значение",
              class: "w-full px-2 py-1 border rounded-md text-sm"%>
        <% elsif input_type == 'text' %>
          <%= ff.text_field :value,
              value: automation_condition.value,
              placeholder: "Значение",
              class: "w-full px-2 py-1 border rounded-md text-sm"%>
        <% else %>
          <%= ff.text_field :value,
              value: automation_condition.value,
              placeholder: "Значение",
              class: "w-full px-2 py-1 border rounded-md text-sm"%>
        <% end %>
        
        <%= ff.hidden_field :position, value: automation_condition.position || automation_rule.automation_conditions.count %>
      </div>

      <!-- Delete button -->
      <div class="flex items-center">
        <% path = automation_condition.new_record? ? account_automation_rule_automation_condition_path(current_account, automation_rule, id: turbo_id_for(automation_condition)) : account_automation_rule_automation_condition_path(current_account, automation_rule, automation_condition) %>
        <%= link_to_delete path, data: { turbo_method: :delete, turbo_confirm: 'Удалить условие?' } %>
        <%= ff.hidden_field :id %>
      </div>
    </div>
  <% end %>
<% end %>