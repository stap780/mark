<div class="mb-4">
  <h1 class="text-xl font-semibold mb-4">Статистика сообщений</h1>

  <!-- Предупреждение о лимите глобального Mailganer -->
  <% if current_account.mailganer.blank? %>
    <% 
      limit = 50
      current_month_start = Time.current.beginning_of_month
      current_month_end = Time.current.end_of_month
      sent_count = current_account.automation_messages
        .where(channel: 'email', status: 'sent')
        .where(sent_at: current_month_start..current_month_end)
        .count
      remaining = [limit - sent_count, 0].max
    %>
    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-3 mb-4">
      <p class="text-sm text-yellow-800">
        <strong>Внимание!</strong>
        <%= t('automation_messages.global_limit_warning', remaining: remaining, limit: limit, reset_date: current_month_end.strftime('%d.%m.%Y')) %>
      </p>
    </div>
  <% end %>

  <!-- Статистика -->
  <div class="grid grid-cols-3 gap-4 mb-4">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="text-sm text-gray-600">Всего отправлено</div>
      <div class="text-2xl font-bold"><%= @stats[:total] %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <div class="text-sm text-gray-600">Успешно</div>
      <div class="text-2xl font-bold text-green-600"><%= @stats[:sent] %></div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
      <div class="text-sm text-gray-600">Ошибок</div>
      <div class="text-2xl font-bold text-red-600"><%= @stats[:failed] %></div>
    </div>
  </div>

  <!-- Фильтры -->
  <%= search_form_for @search, url: account_automation_messages_path(current_account), method: :get, html: { class: "flex items-center space-x-2 mb-4" } do |f| %>
    <%= f.select :automation_rule_id_eq, current_account.automation_rules.pluck(:title, :id), { prompt: t("automation_messages.all_rules") }, class: "px-2 py-1 border rounded" %>
    <%= f.select :channel_eq, AutomationMessage.channels.keys.map { |k| [t("automation_messages.channels.#{k}"), k] }, { prompt: t("automation_messages.all_channels") }, class: "px-2 py-1 border rounded" %>
    <%= f.select :status_eq, AutomationMessage.statuses.keys.map { |k| [t("automation_messages.statuses.#{k}"), k] }, { prompt: t("automation_messages.all_statuses") }, class: "px-2 py-1 border rounded" %>
    <%= f.submit "Фильтровать", class: "px-3 py-1 bg-gray-200 rounded hover:bg-gray-300" %>
    <%= link_to_clear account_automation_messages_path(current_account),
    class: "h-8 px-3 bg-gray-100 rounded hover:bg-gray-200 flex items-center text-sm leading-none" %>
<% end %>
</div>

<div class="bg-white rounded-lg shadow divide-y">
  <div class="grid grid-cols-[50_150px_200px_200px_200px_200px] gap-4 p-4 font-medium text-gray-700">
    <div>#</div>
    <div>Дата</div>
    <div>Правило</div>
    <div>Получатель</div>
    <div>Канал / Статус</div>
    <div>Тема</div>
  </div>
  <%= turbo_frame_tag dom_id(current_account, :automation_messages) do %>
    <%= render @automation_messages %>
    <%= render "shared/paginate", f: @automation_messages %>
  <% end %>
</div>

